import requests
import json
import os
import time
import sys

# Import Stealth Module
sys.path.append(os.path.join(os.path.dirname(__file__), 'modules'))
from Stealth_Manager import StealthSession

# Initialize Stealth Session
stealth = StealthSession(proxy_file="proxies.txt")

# Configuration
SUPABASE_URL = "https://xkjhisxdffqagxprdgrj.supabase.co"
ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhramhpc3hkZmZxYWd4cHJkZ3JqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NzkxNDUsImV4cCI6MjA3NjM1NTE0NX0.4J68HZ_YBjDBEFzQfVcGdXqlzv1bxXgIgheKZCbogSk"

HEADERS = {
    "apikey": ANON_KEY,
    "Authorization": f"Bearer {ANON_KEY}",
    "Content-Type": "application/json"
}

# Update Headers in Stealth Session
stealth.session.headers.update(HEADERS)

OUTPUT_DIR = r"c:\Users\kille\Documents\trae_projects\osint_links\Intelligence_Database\Aureon\Evidence"
os.makedirs(OUTPUT_DIR, exist_ok=True)

TARGET_TABLES = [
    "public_strategies",
    "trading_signals",
    "messages",
    "user_roles",
    "user_known_information",
    "nomad_ip_intelligence",
    "profiles"
]

def dump_table(table_name):
    print(f"\n[+] Dumping table: {table_name}...")
    url = f"{SUPABASE_URL}/rest/v1/{table_name}?select=*"
    
    try:
        # Use stealth.get instead of requests.get
        response = stealth.get(url)
        if response.status_code == 200:
            data = response.json()
            count = len(data)
            print(f"    -> Success! Found {count} records.")
            
            if count > 0:
                filename = os.path.join(OUTPUT_DIR, f"{table_name}_dump.json")
                with open(filename, "w", encoding='utf-8') as f:
                    json.dump(data, f, indent=2)
                print(f"    -> Saved to {filename}")
                
                # Print a small sample for the user
                sample = data[0] if count > 0 else {}
                print(f"    -> Sample: {json.dumps(sample, indent=2)[:500]}...") 
            else:
                print("    -> Table is empty.")
        else:
            print(f"    -> Failed. Status: {response.status_code}")
            print(f"    -> Response: {response.text}")
            
    except Exception as e:
        print(f"    -> Error: {e}")

def check_bucket(bucket_name):
    print(f"\n[+] Checking Storage Bucket: {bucket_name}...")
    url = f"{SUPABASE_URL}/storage/v1/object/list/{bucket_name}"
    try:
        # Use stealth.post
        response = stealth.post(url, json={"prefix": "", "limit": 100, "offset": 0, "sortBy": {"column": "name", "order": "asc"}})
        if response.status_code == 200:
            data = response.json()
            count = len(data)
            print(f"    -> Success! Found {count} files.")
            if count > 0:
                print(f"    -> Sample: {json.dumps(data[0], indent=2)}")
        else:
             print(f"    -> Failed. Status: {response.status_code} - {response.text}")
    except Exception as e:
        print(f"    -> Error: {e}")

def main():
    print("Starting Aureon Data Extraction...")
    print(f"Target: {SUPABASE_URL}")
    print(f"Output Directory: {OUTPUT_DIR}")
    
    for table in TARGET_TABLES:
        dump_table(table)
        time.sleep(1) # Be polite
    
    check_bucket("avatars")
    check_bucket("user-storage")

if __name__ == "__main__":
    main()
