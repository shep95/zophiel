const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/5f70e681-ikhdefthfe6s7yo7.js","assets/2340486e-n0khdanno9uzbccp.js"])))=>i.map(i=>d[i]);
var De=Object.defineProperty,Fe=Object.defineProperties;var Le=Object.getOwnPropertyDescriptors;var Q=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,de=Object.prototype.propertyIsEnumerable;var ce=(e,t,n)=>t in e?De(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,I=(e,t)=>{for(var n in t||(t={}))ue.call(t,n)&&ce(e,n,t[n]);if(Q)for(var n of Q(t))de.call(t,n)&&ce(e,n,t[n]);return e},P=(e,t)=>Fe(e,Le(t));var U=(e,t)=>{var n={};for(var r in e)ue.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(e!=null&&Q)for(var r of Q(e))t.indexOf(r)<0&&de.call(e,r)&&(n[r]=e[r]);return n};import{r as _,e as Oe,j as O,_ as Me}from"./2340486e-n0khdanno9uzbccp.js";import{id as le,e5 as N,ie as W,e8 as T,ig as fe,ih as D,ii as k,ij as be,ik as je,il as qe,im as Qe,io as Ne,ip as $e,iq as Be,dh as ze,dM as Ue,e0 as We,ir as He,bt as Ve,is as Ke}from"./1a7ebd5f-ihenykhpblfwilpu.js";import{r as he}from"./b81d67c1-g85xaexv7seu9n1r.js";import{l2 as pe,g as $,R as Se,rb as Je,ds as Ye,q$ as Ge,e6 as Ze,e8 as Xe,lv as et,eS as tt,e$ as Ie,dA as nt,fC as st,bZ as rt,tV as ot,oa as at,gp as it,P as ct,tW as ut,aW as dt,bp as lt,m as ke}from"./4813494d-di0bpg5zidu9s57f.js";const M={type:T.Conversation},ft=e=>{if(!e)return M;switch(e.type){case"curate":case"preview":return{type:T.Preview};case"card":return M;case"on-card":return e.cardId?{type:T.OnCard,cardId:e.cardId}:M;case"task":case"task-edit":return e.taskId?{type:T.TaskEdit,taskId:e.taskId,composerMessage:e.composerMessage}:M;case"conversation":default:return M}},ve=e=>{var n;const t=(n=e==null?void 0:e.trim())!=null?n:"";return t.length>0?t:null},pt=e=>{if(e.surveyConfig)return e.surveyConfig;const t=e.surveyTopLevelConfig;if(t)return"survey_config"in t?t.survey_config:t.surveyConfig},vt=e=>{var s,a,i;if(!e)return null;const t=(s=e.overlay_content)!=null?s:e.overlayContent,n=ve((a=e.content)==null?void 0:a.title),r=ve(t==null?void 0:t.title);return(i=n!=null?n:r)!=null?i:null},yt=(e,t)=>{var r,s,a;if(!e)return null;const n="surveyTopLevelConfig"in e?e.surveyTopLevelConfig:void 0;if(n){const i="survey_config"in n?n.survey_config:n.surveyConfig,u=(r="feedback_conversation_id"in n?n.feedback_conversation_id:n.feedbackConversationId)!=null?r:t;if(!i||!u)return null;const l=(s="fab_short"in n?n.fab_short:n.fabShort)!=null?s:null,d=(a="fab_long"in n?n.fab_long:n.fabLong)!=null?a:null;return{feedback_conversation_id:u,fab_short:l,fab_long:d,survey_config:i}}return e.type==="survey-reply"&&e.surveyConfig&&t?{feedback_conversation_id:t,fab_short:null,fab_long:null,survey_config:e.surveyConfig}:null},ye=(e,t,n)=>{$().setQueryData(e,s=>{if(e===k.recentPulse&&t!==D||s!=null&&s.survey&&!(s.id!==t||s.survey.feedback_conversation_id!==n.feedback_conversation_id))return s;const i=s!=null?s:{id:t,items:[],feedback:null,survey:null,onboarding:null,expires_at:null,date_timestamp:null};return P(I({},i),{survey:n})})},mt=(e,t)=>{var s;const n=yt(e,t);if(!n)return;const r=(s=e&&"feedId"in e?e.feedId:void 0)!=null?s:D;ye(k.recentPulse,r,n),r&&r!==D&&ye(["pulse-feed",r],r,n)};function Ct(e,t){var r,s,a,i,u,l,d,y,m,b,C;if(((r=t.pulsePrompt)==null?void 0:r.type)==="surveyReply"){if(!t.conversationId)return;const v=le((s=t.pulsePrompt.userMessage)!=null?s:""),g=(a=t.pulsePrompt.targetedReply)!=null?a:null,c=(i=t.pulsePrompt.isAutoSend)!=null?i:!1,h=N();W.set(t.conversationId),c?pe(()=>{h.autoSendCompletion={userMessage:v,targetedReply:g},h.shouldAutoSendCompletion$.set(!0),h.openFeedbackView({type:T.Conversation},{anchorConversationId:e})}):h.openFeedbackView({type:T.Preview,populatePrompt:{type:"surveyReply",userMessage:v,targetedReply:g}},{anchorConversationId:e});return}if(t.pulseOverlayType&&mt(t.pulseOverlayType,t.conversationId),((u=t.pulseOverlayType)==null?void 0:u.type)==="survey-reply"){if(!t.conversationId)return;const v=pt(t.pulseOverlayType),g=vt(v),c=t.pulseOverlayType.suggestion,h=(d=(l=c==null?void 0:c.prompt)!=null?l:c==null?void 0:c.text)!=null?d:"",w=le(h),B=(m=(y=c==null?void 0:c.isAutoSend)!=null?y:c==null?void 0:c.is_auto_send)!=null?m:!1,F=(c==null?void 0:c.type)==="sugar_task"?null:g,p=N();W.set(t.conversationId),B?pe(()=>{p.autoSendCompletion={userMessage:w,targetedReply:F},p.shouldAutoSendCompletion$.set(!0),p.openFeedbackView({type:T.Conversation},{anchorConversationId:e})}):p.openFeedbackView({type:T.Preview,populatePrompt:{type:"surveyReply",userMessage:w,targetedReply:F}},{anchorConversationId:e});return}if(((b=t.pulseOverlayType)==null?void 0:b.type)==="card"){const v=t.pulseOverlayType.cardId;if(!v)return;const g=gt(v),c=(C=t.conversationId)!=null?C:g,h=!!t.conversationId;if(c)fe.set(c),me(v,c,{forceConversationId:h});else{const w=_t(v);fe.set(w),me(v,w,{forceConversationId:!1})}N().openCardView(v,{anchorConversationId:e});return}if(!t.conversationId)return;W.set(t.conversationId);const n=ft(t.pulseOverlayType);N().openFeedbackView(n,{anchorConversationId:e})}const gt=e=>{var r;const n=$().getQueryData(k.pulseCard(e));return(r=n==null?void 0:n.conversation_id)!=null?r:null},_t=e=>{var i,u;const t=Je(),n=t.id,r=Ye(n),s=Ge(),a=$();return r||Ze.initThread({clientThreadId:n,conversationMode:{kind:Xe.PrimaryAssistant},userId:(i=s==null?void 0:s.user)==null?void 0:i.id,accountId:(u=s==null?void 0:s.account)==null?void 0:u.id,disableConversationNavigation:!0,pulseCardId:e}),et(()=>t.serverId$()!==void 0,()=>{const l=t.serverId$();l&&(nt(l,d=>(d.disableConversationNavigation=!0,d)),qe(a,e,l))}),he({conversation:t,sourceEvent:new Event("pulse-card-stream"),promptMessage:Ie(""),completionType:tt.Next,extraStreamParams:{pulseCompletionParams:{type:"card",card_id:e}}}),n},me=async(e,t,n)=>{var l,d,y,m;const r=(l=n==null?void 0:n.forceConversationId)!=null?l:!0,s=$(),a=s.getQueryData(k.pulseCard(e));if(a){const b=r?t:(d=a.conversation_id)!=null?d:t,C=P(I({},a),{conversation_id:b});s.setQueryData(k.pulseCard(e),C),H(s,C);return}const i=(y=be())!=null?y:D,u={id:e,feed_id:i,content_type:"card",conversation_id:t,is_saved:!1,is_dismissed:!1,card_type:"core"};s.setQueryData(k.pulseCard(e),u),H(s,u);try{const b=await Se.safeGet("/feed/card/{card_id}",{parameters:{path:{card_id:e}}});if(!b)return;const C=s.getQueryData(k.pulseCard(e)),v=r?t:(m=C==null?void 0:C.conversation_id)!=null?m:t,g=P(I({},b),{conversation_id:v});s.setQueryData(k.pulseCard(e),g),H(s,g)}catch(b){}},H=(e,t)=>{const n=be(),r=n&&n!==D?["pulse-feed",n]:k.recentPulse;e.setQueryData(r,s=>{var l;const a=(l=s==null?void 0:s.items)!=null?l:[];let i=!1;const u=a.map(d=>je(d)&&d.id===t.id?(i=!0,t):d);return i||u.unshift(t),s?P(I({},s),{items:u}):{id:n!=null?n:D,items:u,feedback:null,survey:null,onboarding:null,expires_at:null,date_timestamp:null}})},bt=lt(()=>Me(()=>import("./5f70e681-ikhdefthfe6s7yo7.js"),__vite__mapDeps([0,1])).then(e=>e.DILRenderer)),ht=!1;let St=null;const Ce=[.18,.02,.25,1],It={hidden:{opacity:0,y:4},show:{opacity:1,y:0,transition:{opacity:{duration:.18,ease:Ce},y:{duration:.25,ease:Ce}}}};function Pe(e,t){if(typeof t=="string"&&t.startsWith("2"))return e;const d=e,{props:n={},children:r=[]}=d,s=U(d,["props","children"]),a=I(I({},n),s),i=(r!=null?r:[]).filter(m=>m!=null).map(m=>Pe(m,t)),y=a,{type:u}=y,l=U(y,["type"]);if(typeof u!="string")throw new Error("Invalid DIL node: missing widget type");return P(I({},l),{type:u,children:i})}const kt=e=>{if(!e||typeof e!="object")return null;const t=e.props;if(!t||typeof t!="object")return null;const n=t.payload;return n&&typeof n=="object"&&!Array.isArray(n)?n:null},Te=(e,t)=>{const n=e.onClickAction;if(n&&typeof n=="object"&&n.type===t){const s=kt(n);if(s)return s}const r=e.children;if(!Array.isArray(r))return null;for(const s of r){if(!s||typeof s!="object")continue;const a=Te(s,t);if(a)return a}return null},Pt=(e,t)=>{if(e)for(const n of t){const r=e[n];if(typeof r=="string"&&r)return r}},Tt=e=>!Pt(e,["card_id","cardId"]),we=e=>{var t,n,r;if(typeof e.detail=="string")return e.detail;if(e.detail&&typeof e.detail=="object"){const s=(r=(n=e.detail.message)!=null?n:(t=e.detail.error)==null?void 0:t.message)!=null?r:e.detail.error;if(typeof s=="string")return s}return e.message},ge=e=>!(e instanceof ke)||e.status!==404?!1:we(e)==="Not found",_e=e=>!(e instanceof ke)||e.status!==404?!1:we(e)==="Message not found",wt=e=>{if(e)try{return JSON.stringify(e)}catch(t){return}},At=({dil:e,dilVersion:t,rootWidget:n,widgetRefId:r,refIndex:s})=>{var X,ee,te,ne,se,re,oe,ae;const a=st(),i=rt(),u=ot(),l=at(),d=Qe({calendarPreferenceFeatureEnabled:ht,CalendarPreferenceModal:St}),y=_.useMemo(()=>{const o=n!=null?n:e?Pe(e,t):null;if(!o)throw new Error("DILWidget requires either a dil or rootWidget");return o},[n,e,t]),m=(ee=(X=y.theme)!=null?X:u)!=null?ee:"light",b=_.useRef(null),C=_.useRef(null),v=_.useMemo(()=>P(I({},y),{theme:m}),[y,m]),g=typeof t=="string"&&t.startsWith("2"),c=g?"flat":"packed",h=g&&n!=null?n:e,w=Ne({mode:c,widget:h},i),B=$e(),{openThreadSidebar:z}=Be(a),{resetSidebarHistory:F}=ze(),p=_.useContext(Ue),Ae=p==null?void 0:p.clientThreadId,j=it(Ae),S=p==null?void 0:p.message,A=S==null?void 0:S.id,q=(ne=(te=p==null?void 0:p.message)==null?void 0:te.metadata)==null?void 0:ne.view_state,L=r&&(q!=null&&q.widgets)?q.widgets[r]:void 0,R=(re=(se=p==null?void 0:p.message)==null?void 0:se.metadata)==null?void 0:re.genui_refresh,Ee=(ae=(oe=S==null?void 0:S.metadata)==null?void 0:oe.is_complete)!=null?ae:S!=null&&S.status?S.status!=="in_progress":!0,V=_.useCallback(({query:o,category:f="ask_sidebar",extraParams:x})=>{!o||!A||(F(),z({type:"entity",debugThreadId:void 0,messageId:A,contentReferenceStartIndex:0,query:o,category:f,extraParams:x}))},[A,z,F]),K=_.useCallback((o,f)=>{ct.logStructuredEvent(ut,{eventName:o,eventData:wt(f)})},[]),J=_.useCallback(async o=>{!a||!(o!=null&&o.trim())||await he({conversation:a,promptMessage:Ie(o.trim()),eventSource:"mouse"})},[a]),Y=_.useCallback(o=>{a&&Ct(a.id,o)},[a]),G=We.useStore(),Z=_.useMemo(()=>({toaster:i,calendar:d,openEntitySidebar:V,issueNewTurn:J,imageLightbox:G,logEvent:K,openPulseOverlay:Y}),[d,J,V,K,Y,i,G]),Re=_.useCallback(async({type:o,payload:f})=>{const E=typeof o=="string"&&o.startsWith("card.")&&Tt(f),ie=E&&o?Te(y,o):null,xe=E?ie?P(I({},ie),{action:o}):void 0:f;await He({payload:xe,context:Z,library:Ke,actionType:o})},[Z,y]);return _.useEffect(()=>{if(L===void 0)return;const o=b.current;if(!o)return;let f=null;try{f=JSON.stringify(L)}catch(x){f=null}f!=null&&C.current===f||(C.current=f,o.setState(L,!0))},[L]),Oe({queryKey:["genui-refresh",j,A,s],enabled:!!(j&&A&&s!==void 0)&&!!(R!=null&&R.enabled&&(R!=null&&R.name))&&Ee,queryFn:async()=>!j||!A||s===void 0?null:await Se.safePost("/conversation/{conversation_id}/message/{message_id}/genui/refresh_widget",{additionalHeaders:void 0,parameters:{path:{conversation_id:j,message_id:A}},requestBody:{ref_index:s}}),refetchInterval:o=>{if(document.visibilityState!=="visible")return!1;const f=o.state.error;if(ge(f))return!1;if(_e(f))return 1e3;const x=o.state.data;if(x){const E=x.next_poll_after_ms;return E==null?!1:typeof E=="number"&&E>0?Math.max(1e3,E):!1}return 5e3},refetchIntervalInBackground:!1,refetchOnWindowFocus:!0,retry:(o,f)=>ge(f)?!1:_e(f)?o<5:o<2}),O.jsxs("div",{className:"mt-4 mb-3",children:[h&&B&&O.jsx("div",{className:"text-token-text-tertiary hover:text-token-text-secondary mb-2 flex justify-end",children:O.jsx(Ve,{onCopy:w,buttonText:"Copy DIL (internal only)"})}),O.jsx(dt.div,{variants:It,initial:l?!1:"hidden",animate:"show",children:O.jsx(bt,{widget:v,theme:m,initialState:L,onAction:Re,onLoad:o=>{b.current=o},onError:()=>{C.current=null}})})]})},Lt=Object.freeze(Object.defineProperty({__proto__:null,DILWidget:At},Symbol.toStringTag,{value:"Module"}));export{At as D,Lt as d,Ct as o};
//# sourceMappingURL=28938d3c-ne58pdayq54airr8.js.map
