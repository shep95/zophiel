const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/0fd78e4f-cac7muhma6x0r5uw.js","assets/2340486e-n0khdanno9uzbccp.js","assets/4813494d-di0bpg5zidu9s57f.js","assets/root-jvstnck2.css","assets/1a7ebd5f-ihenykhpblfwilpu.js","assets/conversation-small-dnpfu486.css","assets/1a5e078c-orjfbgbq9v2hzdjt.js","assets/1bc04b52-b4wr9duki6wfcq7j.js","assets/e6465fe8-b55uck95t0ahph2h.js","assets/1bc04b52-kjqi8i9f3vubqnfc.js","assets/1bc04b52-hu1bt0oauegdhua6.js","assets/1bc04b52-h1em0bjkpkjv8ykw.js","assets/1bc04b52-ejh0m4idynv2xgp8.js","assets/1bc04b52-hylmuees1tuxf0o2.js","assets/b4c3a217-bm4lb0thwj6lecwx.js","assets/1bc04b52-fhkffvy342us9wxq.js","assets/1bc04b52-c7rotu5a6tp3ci80.js","assets/1bc04b52-lv4tv9an6ktv3l0s.js","assets/1bc04b52-gl5z8d62n822jb7m.js","assets/1bc04b52-gn6ju16nxa3wbe97.js","assets/1bc04b52-e722cq7x70uf2ela.js","assets/1bc04b52-jbvp2k2yd8ul63oq.js","assets/1bc04b52-k3wdhrv7c928nig1.js","assets/ce52ae67-lep2wptoy14cfe2w.js","assets/bc18f706-ggmfm6vsm8xfjh2h.js","assets/1bc04b52-j8mdq0okhi6vw6kp.js"])))=>i.map(i=>d[i]);
var at=Object.defineProperty,ot=Object.defineProperties;var rt=Object.getOwnPropertyDescriptors;var Ie=Object.getOwnPropertySymbols;var dt=Object.prototype.hasOwnProperty,ct=Object.prototype.propertyIsEnumerable;var _e=(h,e)=>(e=Symbol[h])?e:Symbol.for("Symbol."+h),Se=h=>{throw TypeError(h)};var ee=(h,e,t)=>e in h?at(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t,N=(h,e)=>{for(var t in e||(e={}))dt.call(e,t)&&ee(h,t,e[t]);if(Ie)for(var t of Ie(e))ct.call(e,t)&&ee(h,t,e[t]);return h},D=(h,e)=>ot(h,rt(e));var S=(h,e,t)=>ee(h,typeof e!="symbol"?e+"":e,t),lt=(h,e,t)=>e.has(h)||Se("Cannot "+t);var Me=(h,e,t)=>e.has(h)?Se("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(h):e.set(h,t);var T=(h,e,t)=>(lt(h,e,"access private method"),t);var K=(h,e,t)=>(e=h[_e("asyncIterator")])?e.call(h):(h=h[_e("iterator")](),e={},t=(s,i)=>(i=h[s])&&(e[s]=n=>new Promise((g,a,l)=>(n=i.call(h,n),l=n.done,Promise.resolve(n.value).then(o=>g({value:o,done:l}),a)))),t("next"),t("return"),e);import{_ as je}from"./2340486e-n0khdanno9uzbccp.js";import{jC as ht,d9 as ye,cO as $,e6 as Ee,dA as M,dq as b,dW as x,eS as J,dJ as R,eq as be,ds as w,dC as Y,dP as ut,ef as te,al as H,eR as gt,e as se,ar as mt,ry as pt,er as ie,em as Re,g9 as ft,H as ke,az as vt,kA as Tt,dt as Ne,rz as Ct,P as U,rA as It,an as ne,en as _t,il as St,ho as Mt,dZ as ae,rB as yt,m as G,ek as Ae,l as we,ep as Pe,es as Et,cB as Fe,bp as bt,e_ as Oe,jt as oe,ju as qe,dR as re,qv as Rt,rC as kt,ga as Nt,kB as At,kC as wt,kG as Pt,bZ as Ft,du as O,e7 as B,d$ as xe,rD as de,rE as Le,jO as Ot,fM as De,rF as qt,fw as xt}from"./4813494d-di0bpg5zidu9s57f.js";import{aB as Lt,aC as Dt,aD as Ut,aE as Ue,aF as Bt,aG as Ht,aH as Gt,aI as jt,aJ as zt,aK as ce,aL as le,aM as Wt,aN as Qt,aO as Be,aP as Vt,aQ as Kt,aR as $t,aS as Jt,aT as He,aU as Yt,aV as Zt,aW as Xt,aX as es,aY as j,aZ as ts,a_ as ss,a$ as is,b0 as ns,b1 as as,b2 as os,b3 as rs,b4 as ds,b5 as cs,i as ls,b6 as Ge}from"./1a7ebd5f-ihenykhpblfwilpu.js";const hs=.5,us=bt(()=>je(()=>import("./0fd78e4f-cac7muhma6x0r5uw.js"),__vite__mapDeps([0,1,2,3,4,5])).then(h=>h.QuietHoursModal));function gs(){const h=ms();return h?h.gapPx>h.viewportHeightPx*hs:!1}function ms(){if(typeof window>"u"||typeof document>"u")return null;const h=document.getElementById("thread");if(!h)return null;const e=h.querySelectorAll('[data-turn="user"]');if(!e.length)return null;const t=e[e.length-1],s=window.innerHeight;if(!Number.isFinite(s)||s<=0)return null;const{bottom:i}=t.getBoundingClientRect();return{gapPx:s-i,viewportHeightPx:s}}var c,ze,We,Qe,Ve,Ke,$e,Je,Ye,Ze,Xe,et,tt,st,it,nt,he,Z,ue,ge;class Cs{constructor(e,t,s,i,n,g,a,l,o,r,d,u,f,v,y,p,C,m,I,_=!1,E,A=!1,q=!1,F,z=void 0,L,P,W=!1,Q=!1){Me(this,c);S(this,"isFirstCompletionInThread");S(this,"activeBranchLastMessage");S(this,"messagesToUpdate",{});S(this,"allIncompleteMessageIds",new Set);S(this,"responseThreadId");S(this,"isCompletionBlocked",!1);S(this,"isEitherFlagged",!1);S(this,"sentNotification",!1);S(this,"variantsInStreamInfo");S(this,"blurDuringCompletionTracker",new Dt);S(this,"completionLatencyTracker");S(this,"preflightTime");S(this,"treatCompletionAsAsync",!1);S(this,"realtimeAsyncCompletion",!1);S(this,"resumeToken");S(this,"placeholderNodeId");S(this,"callbacks");S(this,"handleResponse",e=>{var t,s,i,n,g;if(this.activeBranchLastMessage&&this.completionLatencyTracker.onResponse(e,this.activeBranchLastMessage,this.responseThreadId),this.responseThreadId===void 0&&"conversationId"in e){const a=e.conversationId;if(this.responseThreadId=a,this.turnTracker.onConversationId(a),(s=(t=this.callbacks)==null?void 0:t.onServerThreadId)==null||s.call(t,a),Tt(this.conversation.id)&&Ne(this.conversation.id)!==a&&(Ct(this.conversation.id,a),U.logEvent("Attribution: Client Thread to Server Thread",{client_thread_id:this.conversation.id,server_thread_id:a})),$()||It.set(a),this.isContinuingFromSharedConversation&&(M(this.conversation.id,o=>{delete o.continuingFromSharedConversationId}),ne.logEvent("chatgpt_continue_conversation_first_message_sent"),U.logEvent("Continue Conversation: First Message Sent",{forked_conversation_id:a,shared_conversation_id:(i=this.initialThread)==null?void 0:i.continuingFromSharedConversationId})),this.isContinuingFromBranchingConversation&&M(this.conversation.id,o=>{delete o.branchingFromConversationId,delete o.branchingFromMessageId}),this.isContinuingFromSharedProjectConversation&&M(this.conversation.id,o=>{delete o.continuingFromSharedProjectConversationId,delete o.sharedProjectConversationOwner}),this.isContinuableSharedPost&&M(this.conversation.id,o=>{delete o.continuingFromSharedPostId,delete o.forkFromSharedPost}),this.isFirstCompletionInThread){const o=w(this.conversation.id);if(U.logEvent("Create New Thread"),!this.isHistoryAndTrainingDisabled&&Kt(o==null?void 0:o.mode)&&$()){_t(this.queryClient,b.getGizmoId(o));const r=St()&&se();o!=null&&o.disableConversationNavigation||$t(Mt,this.queryClient,a,this.isProjectEnabledForGizmo,void 0,r)}}const l={id:this.requestId,threadId:this.responseThreadId,completionType:this.completionType,eventSource:this.eventSource,model:this.model};if(this.completionType===J.Next){const o=b.getConversationTurns(w(this.conversation.id)),r=o.length,d=o.filter(f=>f.role===x.User),u=d&&((n=d[d.length-1])==null?void 0:n.messages[0]);if((u==null?void 0:u.content.content_type)===ae.Text){const f=u.content.parts.join("").length,v=(g=d==null?void 0:d.length)!=null?g:0;l.countConversationTurns=r,l.countUserSubmittedMessages=v,l.countLastUserPromptTextMessageLength=f}}U.logEvent("Generate Completion",l)}switch(e.type){case"num_variants_in_stream":T(this,c,Xe).call(this,e);break;case"moderation":T(this,c,it).call(this,e);break;case"url_moderation":T(this,c,nt).call(this,e);break;case"message":T(this,c,he).call(this,e);break;case"input_message":T(this,c,he).call(this,e);break;case"done":T(this,c,ue).call(this);break;case"gizmo_inline_review":T(this,c,Qe).call(this,e);break;case"title_generation":T(this,c,Ve).call(this,e);break;case"conversation_detail_metadata":T(this,c,Ke).call(this,e);break;case"beacon_ui_response":T(this,c,$e).call(this,e,this.responseThreadId);break;case"toast":T(this,c,Je).call(this,e);break;case"survey_campaign_effect":Jt(e);break;case"conversation_async_status":T(this,c,Ye).call(this,e);break;case"resume_conversation_token":T(this,c,Ze).call(this,e);break;case"display_crisis_helpline_message":T(this,c,et).call(this,e);break;case"display_crisis_helpline_modal":T(this,c,tt).call(this,e);break;case"ads":T(this,c,st).call(this,e)}});S(this,"debouncedUpdateExistingMessages",Ot(()=>{if(this.isCompletionBlocked)return;const e=Object.values(this.messagesToUpdate);e.length!==0&&(M(this.conversation.id,t=>{R.updateTree(t,s=>{for(const i of e)s.updateNodeMessage(i.id,i),i.status!=="in_progress"&&(s.updateNodeMetadata(i.id,{completionSampleFinishTime:Date.now()}),this.allIncompleteMessageIds.delete(i.id))})}),this.messagesToUpdate={})},50,{leading:!0,maxWait:50}));this.requestId=e,this.queryClient=t,this.initialThread=s,this.conversation=i,this.parentMessageId=n,this.prependMessages=g,this.promptMessage=a,this.appendMessages=l,this.completionType=o,this.model=r,this.eventSource=d,this.isHistoryAndTrainingDisabled=u,this.startPreflightTime=f,this.isProjectEnabledForGizmo=v,this.isNewThread=y,this.isContinuingFromSharedConversation=p,this.isContinuingFromBranchingConversation=C,this.isContinuingFromSharedProjectConversation=m,this.turnTracker=I,this.isAnonModeEnabled=E,this.isContinuableSharedPost=A,this.isReasoningSkipped=q,this.thinkingEffort=F,this.modelSlugStatsOverride=z,this.asyncTaskId=L,this.canEnableAuraAdultSearch=W,this.isAuraAdultSearchEnabled=Q,this.completionLatencyTracker=new Lt(this.requestId,f),this.isFirstCompletionInThread=y||this.isContinuingFromSharedConversation||this.isContinuingFromSharedProjectConversation||this.isContinuableSharedPost||this.isContinuingFromBranchingConversation;const V=typeof L=="string"&&L.startsWith("thinking");!(P!=null&&P.disablePlaceholder)&&!V&&(this.placeholderNodeId="".concat(ht).concat(e)),this.callbacks=P!=null?P:{},_&&(this.sentNotification=!0)}updateBeforeRequest(){Ut.incrementUserMessageCount($()?ye.LoggedIn:ye.LoggedOut),Ee.retainThread(this.conversation.id),M(this.conversation.id,e=>{var n,g,a,l,o;e.stopConduitToken=(n=e.conduitToken)!=null?n:null,e.prepareState=null,e.lastPrepareTimestamp=null;const t=this.parentMessageId?b.getNode(e,this.parentMessageId):void 0,s=(t==null?void 0:t.message.author.role)===x.User,i=gs();this.completionType===J.Next&&b.hasUserMessage(e)&&((g=this.promptMessage)==null?void 0:g.author.role)===x.User&&!((l=(a=this.promptMessage)==null?void 0:a.metadata)!=null&&l.is_visually_hidden_from_conversation)&&!(s&&i)&&(e.scrollToMessageId=(o=this.promptMessage)==null?void 0:o.id),R.updateTree(e,(r,d)=>{if(this.parentMessageId&&(d=b.getNode(e,this.parentMessageId).id),this.prependMessages)for(const u of this.prependMessages)u.clientMetadata=D(N({},u.clientMetadata),{isOptimistic:!0}),d=r.addMessageNode(d,u);if(this.promptMessage){const u=this.promptMessage;u.clientMetadata=D(N({},u.clientMetadata),{isOptimistic:!0}),d=r.addMessageNode(d,u)}if(this.appendMessages)for(const u of this.appendMessages)u.clientMetadata=D(N({},u.clientMetadata),{isOptimistic:!0}),d=r.addMessageNode(d,u);if(this.placeholderNodeId){const u=be("",void 0,{requestId:this.requestId,isPlaceholder:!0},this.placeholderNodeId);d=r.addMessageNode(d,u)}return d})})}async sendRequest({conduitToken:e,turnstileToken:t,proofToken:s,completionMetadata:i,resolvedParentMessageId:n,messages:g,extraStreamParams:a,chatReq:l,profiler:o}){var _,E,A,q,F,z,L,P,W,Q,V,me,pe,fe,ve,Te,Ce;Ue(this.conversation.id,!0);let r=!1,d=!1,u=!1;const f=k=>ce(k),v=(E=(_=w(this.conversation.id))==null?void 0:_.is_do_not_remember)!=null?E:!1,y=new AbortController;Y.addRequest(this.requestId,y,this.turnTracker);const p=ut(),C=te(this.conversation.serverId$);if(this.completionType===J.Variant&&C==null){H.addError("Generating variant without conversation_id"),this.handleError(new Error("Regeneration must have conversation_id"));return}const m=te(gt),I=Bt(D(N(N(N({conversationOrigin:(q=(A=this.initialThread)==null?void 0:A.conversationOrigin)!=null?q:null,atlasConversationSurface:m,model:this.model,completionType:this.completionType,prepareState:(z=(F=this.initialThread)==null?void 0:F.prepareState)!=null?z:"none",conduitToken:e,threadId:C,isReasoningSkipped:this.isReasoningSkipped,asyncTaskId:this.asyncTaskId,overrideInferTreatment:p.autoSwitcherTreatmentOverride,modelSlugStatsOverride:this.modelSlugStatsOverride,continueFromSharedConversationId:(L=this.initialThread)==null?void 0:L.continuingFromSharedConversationId,branchingFromConversationId:(P=this.initialThread)==null?void 0:P.branchingFromConversationId,branchingFromMessageId:(W=this.initialThread)==null?void 0:W.branchingFromMessageId,sharedProjectConversationOwnerId:(V=(Q=this.initialThread)==null?void 0:Q.sharedProjectConversationOwner)==null?void 0:V.id,sharedProjectConversationId:(me=this.initialThread)==null?void 0:me.continuingFromSharedProjectConversationId,continueFromSharedPostId:(pe=this.initialThread)==null?void 0:pe.continuingFromSharedPostId,forkFromSharedPost:(fe=this.initialThread)==null?void 0:fe.forkFromSharedPost,historyDisabled:this.isHistoryAndTrainingDisabled,isAnonModeEnabled:this.isAnonModeEnabled,isDoNotRemember:v,parentMessageId:n,messages:g,chatReq:l,turnstileToken:t,proofToken:s,completionMetadata:i,contextualInfo:N({is_dark_mode:pt(),time_since_loaded:Math.floor(performance.now()/1e3),page_height:window.innerHeight,page_width:window.innerWidth,pixel_ratio:window.devicePixelRatio,screen_height:window.screen.height,screen_width:window.screen.width,window_style:mt().windowStyle},jt()),isOnboardingConversation:i==null?void 0:i.isOnboardingConversation,thinkingEffort:T(this,c,ze).call(this),forceParagen:p.forceParagen,forceParagenModel:p.forceParagen?p.forceParagenModel.value:void 0,forceRateLimit:p.forceRateLimit,resetRateLimits:p.resetRateLimits,recordRendering:p.recordRendering,recordTransformedConvoJson:p.recordTransformedConvoJson,disableSystemContentToggling:p.rebaseSystemMessageContent!=null,forceUseSearch:(ve=p.forceUseSearch)!=null?ve:void 0,paragenStreamType:p.paragenStreamType,paragenCotSummaryDisplay:p.paragenCotSummaryDisplay,forceParallelSwitch:p.forceParallelSwitch,juiceScore:p.juiceScore,multimodalJuiceScore:p.multimodalJuiceScore,showAllAnswers:p.showAllAnswers,ncOverride:p.ncOverride,cprOverride:p.cprOverride,cmOverride:p.cmOverride},Gt()?{f_completion:!0}:{}),Ht()?{f_search:!0}:{}),a),{r2xg7vml:se()?this.canEnableAuraAdultSearch:void 0,zafn3kp8:se()?this.isAuraAdultSearchEnabled:void 0}),this.turnTracker,o,y.signal,this.conversation.id);zt("next_turn");try{try{for(var Ss=K(I),Ms,ys,Es;Ms=!(ys=await Ss.next()).done;Ms=!1){const k=ys.value;if("type"in k&&k.type==="connected")r||(f("streamOpened"),r=!0),this.handleStreamConnected(k);else if(le(k)){const X=k;X.type==="message"&&(d||(f("messageReceived"),d=!0),!u&&((Ce=(Te=X.message)==null?void 0:Te.author)==null?void 0:Ce.role)===x.Assistant&&(f("assistantMessageReceived"),u=!0)),this.handleResponse(X)}}}catch(ys){Es=[ys]}finally{try{Ms&&(ys=Ss.return)&&await ys.call(Ss)}finally{if(Es)throw Es[0]}}}catch(k){ie(k)||y.signal.aborted?(f("streamAborted"),T(this,c,Z).call(this,k)):(f("streamError"),this.handleError(k))}finally{r&&f("streamClosed"),Ue(this.conversation.id,!1)}}async sendResumeRequest({conversationId:e,resumeToken:t,profiler:s}){var r,d,p,C;let i=!1,n=!1,g=!1;const a=m=>ce(m),l=new AbortController;Y.addRequest(this.requestId,l,this.turnTracker),M(this.conversation.id,m=>{R.setRequestIdOnCurrentLeaf(m,this.requestId)});const o=Wt({conversationId:e,resumeToken:t,model:this.model},this.turnTracker,s,l.signal,this.conversation.id);try{try{for(var u=K(o),f,v,y;f=!(v=await u.next()).done;f=!1){const I=v.value;if(I.type==="connected")i||(a("streamOpened"),i=!0),this.handleStreamConnected(I);else if(le(I)){const _=I;_.type==="message"&&(n||(a("messageReceived"),n=!0),!g&&((d=(r=_.message)==null?void 0:r.author)==null?void 0:d.role)===x.Assistant&&(a("assistantMessageReceived"),g=!0)),this.handleResponse(_)}}}catch(v){y=[v]}finally{try{f&&(v=u.return)&&await v.call(u)}finally{if(y)throw y[0]}}this.turnTracker.onResumeRequestSucceeded();const m=(C=(p=this.turnTracker.result)==null?void 0:p.type)!=null?C:Re.Success;this.turnTracker.finalizeReloadLifecycle(m,"resume_stream")}catch(m){ie(m)||l.signal.aborted?(a("streamAborted"),T(this,c,Z).call(this,m)):(a("streamError"),this.handleError(m))}finally{i&&a("streamClosed")}}async resumeWithPolling({conversationId:e,profiler:t,turnTraceId:s}){var r,d,u,f;let i=!1,n=!1,g=!1;const a=m=>ce(m),l=new AbortController;Y.addRequest(this.requestId,l,this.turnTracker),M(this.conversation.id,m=>{R.setRequestIdOnCurrentLeaf(m,this.requestId)}),this.responseThreadId=e,this.turnTracker.onConversationId(e),(d=(r=this.callbacks)==null?void 0:r.onServerThreadId)==null||d.call(r,e),a("streamOpened"),i=!0;const o=Qt(e,{signal:l.signal,turnTraceId:s!=null?s:this.turnTracker.turn_trace_id});try{try{for(var v=K(o),y,p,C;y=!(p=await v.next()).done;y=!1){const m=p.value;if(le(m)){const I=m;I.type==="message"&&(n||(a("messageReceived"),n=!0),!g&&((f=(u=I.message)==null?void 0:u.author)==null?void 0:f.role)===x.Assistant&&(a("assistantMessageReceived"),g=!0)),this.handleResponse(I)}}}catch(p){C=[p]}finally{try{y&&(p=v.return)&&await p.call(v)}finally{if(C)throw C[0]}}}catch(m){ie(m)||l.signal.aborted?(a("streamAborted"),T(this,c,Z).call(this,m)):(a("streamError"),this.handleError(m))}finally{i&&a("streamClosed")}}handleStreamConnected(e){const{serverRequestId:t,interruptConversationToken:s}=e;this.turnTracker.onStreamOpen(s!==null),t&&this.turnTracker.onReceivedServerRequestId(t),s&&M(this.conversation.id,i=>{i.conduitToken=s}),Vt(this.requestId,this.model,t,vt(this.preflightTime))}handleError(e){var r,d,u,f;const t=yt(e),s=t.message,i=s===Pe,n=e instanceof G?e.code:i?Ae.NetworkError:void 0,g=e instanceof G?(r=e.detail)==null?void 0:r.can_retry:void 0,a=e instanceof G&&[404,409,410].includes(e.status)&&e.url.includes("/conversation/resume")&&we("4139866856"),l=(i||a)&&!this.treatCompletionAsAsync&&$()&&ke("2489999880").get("is_polling_enabled",!1);l&&(this.treatCompletionAsAsync=!0),this.turnTracker.onRequestError(t,l,l?"sse_disconnect":void 0),l||this.turnTracker.finalizeReloadLifecycle(Re.Error,"resume_stream"),this.debouncedUpdateExistingMessages.flush(),this.treatCompletionAsAsync&&s===Pe&&!l||a||M(this.conversation.id,v=>{R.updateTree(v,(y,p)=>{var I,_,E,A,q;const C=this.variantsInStreamInfo&&(_=(I=b.getParentPromptNode(v))==null?void 0:I.id)!=null?_:p,m={err:l?Et:s,errType:l?"info":"danger",errCode:l?Ae.NetworkErrorWithReconnection:n,completionSampleFinishTime:Date.now(),canRetry:l?!1:g};if(((q=(A=(E=y.getNodeIfExists(C))==null?void 0:E.message)==null?void 0:A.content)==null?void 0:q.content_type)!==ae.Text){const F=be("");return F.clientMetadata=N(N({},F.clientMetadata),m),y.addMessageNode(C,F)}else y.updateNodeMetadata(C,m)})});try{typeof s=="string"&&s.toLowerCase().includes("blackout hours")&&Fe(us)}catch(v){}try{const v=w(this.conversation.id),y=b.getLastMessageSystemHints(v);if(y==null?void 0:y.includes(Oe)){const C=e instanceof G?e:void 0,m=C==null?void 0:C.status,I=(d=C==null?void 0:C.isClientError())!=null?d:!1,_=(u=C==null?void 0:C.isServerError())!=null?u:!1,E=i?"network":_?"server":I?"client":"unknown";H.addAction("agent.conversation.start_failed",{request_id:this.requestId,model:this.model,error_code:n!=null?n:"unknown",is_network_error:i,is_recoverable_error:l,error_status:m,is_client_error:I,is_server_error:_,error_type:E})}}catch(v){}if(i){const v={source:"request_stream",type:l?"info_polling":"error"};U.logEvent("chatgpt_web_network_error",v),ne.logEvent("chatgpt_web_network_error",null,v)}switch(n){case qe.ContentPolicy:case qe.ContentOrTos:case oe.ModelCapExceeded:case oe.HistoryDisabledConversationNotFound:break;default:s!==void 0&&ne.logEvent("chatgpt_conversation_error_web",s)}if(this.blurDuringCompletionTracker.onMessageError(),He(t),T(this,c,ge).call(this),re.publish({kind:"completionFinished",serverThreadId:this.responseThreadId}),e instanceof G&&e.code===oe.ModelCapExceeded){const v=(f=e.detail)==null?void 0:f.clears_in;v&&(Yt(new Date(Date.now()+v*1e3).toISOString()),setTimeout(()=>{Zt()},v*1e3))}}async maybeSendNotification(){var a;if(this.sentNotification)return;const e=w(this.conversation.id),t=(a=e==null?void 0:e.title)!=null?a:void 0;if(!t)return;const s=b.getCurrentNode(e).message;if(xe(s)&&!ds(s))return;const i=l=>l.type==="grouped_webpages"&&l.style==="hidden",n=s.content,g=(n==null?void 0:n.content_type)===ae.Text?cs(await je(()=>import("./1a5e078c-orjfbgbq9v2hzdjt.js").then(l=>l.i),__vite__mapDeps([6,2,1,3,4,5,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25])).then(l=>{var o,r,d;return l.messageTextToPlaintext((o=n.parts[0])!=null?o:"",((d=(r=s.metadata)==null?void 0:r.content_references)!=null?d:[]).filter(u=>!i(u)))}),120):void 0;xt({title:t,subtitle:g,clientThreadId:this.conversation.id}),this.sentNotification=!0}}c=new WeakSet,ze=function(){if(this.model!==Be){const t=te(()=>ft(this.conversation));if(this.model!==Be&&!t.configurableThinkingEffort)return}if(ke("790459319").get("show-juice-control",!1))return this.thinkingEffort},We=function(){var e;return this.promptMessage?this.promptMessage.id:(e=b.getParentPromptNode(w(this.conversation.id),this.parentMessageId))==null?void 0:e.message.id},Qe=function({gizmoId:e}){M(this.conversation.id,t=>{t.promptGptRating={gizmoId:e}})},Ve=function(e){Xt(e.conversation_id,e.title,Rt.Generated),this.isProjectEnabledForGizmo||kt(e.conversation_id,e.title)},Ke=function(e){const{default_model_slug:t}=e;t&&!Nt({id:t})&&M(this.conversation.id,i=>{i.defaultModelId=t}),we("3315017149")&&At(e)&&this.queryClient.invalidateQueries({queryKey:wt()}),Pt.updateDetails(e)},$e=function(e,t){var i,n;const s=(n=(i=this.activeBranchLastMessage)==null?void 0:i.id)!=null?n:b.getCurrentLeafId(w(this.conversation.id));es.updateDetails(e,t!=null?t:void 0,s)},Je=function(e){var a;const t=Ft(),s=(a=e.toast_id)!=null?a:void 0,i=s?{id:s}:void 0,n=s?{id:s}:void 0,g=s?{id:s,toastId:s}:void 0;if(e.level==="warning"){t.warning(e.message,i);return}if(e.level==="success"){t.success(e.message,n);return}t.danger(e.message,g)},Ye=function(e){const{async_status:t}=e;t===O.REALTIME&&(this.realtimeAsyncCompletion=!0),this.responseThreadId&&j(this.responseThreadId,{source:B.SERVER,value:t}),j(this.conversation.id,{source:B.SERVER,value:t})},Ze=function(e){var g,a;const{token:t}=e;this.resumeToken=t!=null?t:void 0;const s=w(this.conversation.id),i=b.getLastMessageSystemHints(s),n=i==null?void 0:i.includes(Oe);this.realtimeAsyncCompletion&&n&&H.addAction("agent.conversation.start_succeeded",{conversation_id:(a=(g=e.conversation_id)!=null?g:this.responseThreadId)!=null?a:"",request_id:this.requestId,model:this.model})},Xe=function(e){this.variantsInStreamInfo=e,M(this.conversation.id,t=>{R.updateTree(t,(s,i)=>{var g;const n=(g=b.getParentPromptNode(t))!=null?g:s.getNodeByIdOrMessageId(i);s.updateNodeMetadata(n.id,{variantsInStreamInfo:this.variantsInStreamInfo})})})},et=function(e){M(this.conversation.id,t=>{R.updateTree(t,s=>{s.updateNodeMessageMetadata(e.messageId,{crisis_helpline_message:e})})})},tt=function(e){Fe(ts,{effect:e})},st=function(e){const t=T(this,c,We).call(this);t&&ss(this.conversation,t,e)},it=function(e){const{isCompletion:t,flagged:s,blocked:i,disclaimers:n}=e,g=!!(n!=null&&n.length);(s||i||g)&&(this.debouncedUpdateExistingMessages.flush(),this.isEitherFlagged=!0,i&&t&&(this.isCompletionBlocked=!0),is(e,this.conversation.id))},nt=function(e){const{conversationId:t,url:s,isSafe:i}=e;i&&M(t,n=>{n.safeUrls.push(s)})},he=function({type:e,message:t,conversationId:s}){var i,n,g,a,l;if(e==="message"&&(this.activeBranchLastMessage=t),(xe(t)||ns(t))&&((n=(i=this.callbacks)==null?void 0:i.onImageGenMessage)==null||n.call(i,t)),(t==null?void 0:t.author.role)===x.Tool&&(t==null?void 0:t.author.name)==="bio"){const o=(g=t.metadata)==null?void 0:g.gizmo_id;setTimeout(()=>{this.queryClient.invalidateQueries({queryKey:as(o)}),this.queryClient.invalidateQueries({queryKey:os()})},5e3)}if((a=t.metadata)!=null&&a.trigger_async_ux&&(this.treatCompletionAsAsync=!0,j(this.conversation.id,{source:B.SERVER,value:O.STREAMING})),b.getTree(w(s)).containsNodeOrMessageId(t.id)){this.messagesToUpdate[t.id]=t,this.debouncedUpdateExistingMessages();const o=(l=t.metadata)==null?void 0:l.parent_id;if(!o)return;M(this.conversation.id,r=>{R.updateTree(r,d=>{const u=d.getNodeIfExists(t.id),f=d.getNodeIfExists(o);if(!u){H.addError(new Error("CompletionRequest handleMessage: message ".concat(t.id," not found in tree")));return}if(!f){H.addAction("conversation.input_missing_expected_parent",{message_id:t.id,parent_id:o,completion_type:this.completionType});return}u.parentId!==f.id&&(d.moveNode(f.id,u.id),this.placeholderNodeId&&d.getNodeIfExists(this.placeholderNodeId)&&d.getParent(this.placeholderNodeId).id===d.getNodeByIdOrMessageId(o).id&&(de(t)?d.moveNode(u.id,this.placeholderNodeId):Le(t)||(d.deleteNode(this.placeholderNodeId),this.placeholderNodeId=void 0)))})});return}this.debouncedUpdateExistingMessages.flush(),M(this.conversation.id,o=>{R.updateTree(o,(r,d)=>{var y,p,C,m,I;const u={requestId:this.requestId};t.status!=="in_progress"?u.completionSampleFinishTime=Date.now():this.allIncompleteMessageIds.add(t.id);const f=D(N({},t),{clientMetadata:u});(y=t.metadata)!=null&&y.invoked_resource&&(o.startedWithByoMcp||(o.startedWithByoMcp=((p=t.metadata)==null?void 0:p.invoked_resource.publish_status)==="private"));const v=(C=t.metadata)==null?void 0:C.parent_id;if(v){if(this.placeholderNodeId&&r.getNodeIfExists(this.placeholderNodeId)&&r.getNodeIfExists(v)&&r.getParent(this.placeholderNodeId).id===r.getNodeByIdOrMessageId(v).id)if(de(f)){r.prependNode(this.placeholderNodeId,f);return}else Le(f)||(r.getNodeIfExists(this.placeholderNodeId)&&r.deleteNode(this.placeholderNodeId),this.placeholderNodeId=void 0);if(!r.containsNodeOrMessageId(v))return;const _=r.getNodeByIdOrMessageId(v).children,E=r.addMessageNode(v,f);if(this.completionType===J.Next&&((I=(m=this.variantsInStreamInfo)==null?void 0:m.num_variants_in_stream)!=null?I:0)<=1&&_.length>0){for(const A of _)A!==E&&r.moveNode(E,A);return}return E}else{const _=r.findFirst(E=>!de(E.message));if(_)r.prependNode(_.id,f);else return r.addMessageNode(d,f)}})})},Z=function(e){this.debouncedUpdateExistingMessages.flush(),M(this.conversation.id,t=>{R.updateTree(t,s=>{for(const i of this.allIncompleteMessageIds)s.updateNodeMessageMetadata(i,{finish_details:{type:"interrupted"}})})}),T(this,c,ue).call(this)},ue=function(){var e;if(this.debouncedUpdateExistingMessages.flush(),this.isEitherFlagged||re.publish({kind:"completionFinished",serverThreadId:this.responseThreadId}),this.isFirstCompletionInThread&&this.responseThreadId){const t=b.getGizmoId(w(this.responseThreadId)),s=this.queryClient.getQueryState([De,{gizmoId:t}]);if((s==null?void 0:s.fetchStatus)!=="fetching"){const i=this.queryClient.getQueryData([De,{gizmoId:t}]);((e=i==null?void 0:i.pages.flatMap(a=>a.items))!=null?e:[]).some(a=>a.id===this.responseThreadId)||(qt(this.queryClient,t),U.logEventWithStatsig("Refetch Project Conversation in Completion Request","chatgpt_web_projects_completion_request_new_chat_refetch"))}}re.publish({kind:"createConversation",clientThreadId:this.conversation.id}),this.blurDuringCompletionTracker.onMessageDone(),He(),this.responseThreadId&&rs.remove(this.responseThreadId),T(this,c,ge).call(this)},ge=function(){M(this.conversation.id,e=>{if(e.turnTraceId=null,e.shouldRefetchConvoOnFinalize){const t=Ne(this.conversation.id);t&&(ls(t,{skipIfExisting:!1,source:"completion_finalize_refetch"}),R.setShouldRefetchConvoOnFinalize(e,!1))}R.updateTree(e,t=>{for(const s of this.allIncompleteMessageIds)t.updateNodeMetadata(s,{completionSampleFinishTime:Date.now()})})}),this.allIncompleteMessageIds.clear(),setTimeout(()=>{if(this.treatCompletionAsAsync||this.realtimeAsyncCompletion){const e=this.treatCompletionAsAsync?O.STREAMING:O.REALTIME,t=s=>{if(!s)return;const i=Ge(s);(i==null||i.source===B.CLIENT)&&j(s,{source:B.SERVER,value:e})};t(this.responseThreadId),t(this.conversation.id)}else{const e=Ge(this.conversation.id);(e==null?void 0:e.value)!==O.REALTIME&&(e==null?void 0:e.value)!==O.REALTIME_BUSY&&(e==null?void 0:e.value)!==O.REALTIME_BACKGROUND&&(j(this.conversation.id,{source:B.CLIENT,value:O.UNREAD}),this.maybeSendNotification())}Y.removeRequest(this.requestId),Ee.releaseThread(this.conversation.id)},0)};export{Cs as C};
//# sourceMappingURL=b9ebfa06-o5t8gt8380co00ia.js.map
