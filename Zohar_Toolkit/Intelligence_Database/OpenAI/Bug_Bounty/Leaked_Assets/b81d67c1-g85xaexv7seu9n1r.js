var Tt=Object.defineProperty;var Ve=Object.getOwnPropertySymbols;var St=Object.prototype.hasOwnProperty,vt=Object.prototype.propertyIsEnumerable;var Ge=(e,s,i)=>s in e?Tt(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i,ee=(e,s)=>{for(var i in s||(s={}))St.call(s,i)&&Ge(e,i,s[i]);if(Ve)for(var i of Ve(s))vt.call(s,i)&&Ge(e,i,s[i]);return e};import{v as At,c as It}from"./2340486e-n0khdanno9uzbccp.js";import{g as te,tI as se,ds as ne,dA as D,H as _t,bh as Ue,ef as a,jv as Et,g9 as oe,hp as ie,dq as b,dW as je,jC as bt,tJ as ae,eb as re,dt as de,tK as ue,mb as O,tL as Rt,eO as le,rM as kt,eP as ce,eQ as me,K as Pt,L as qt,eS as wt,tM as Ft,e_ as Ht,l as ze,dk as Nt,eu as Lt,dI as Ot,bG as $t,al as Be,dR as Dt,du as q,e7 as fe,tN as Qe,aS as Je,aT as Ke,dJ as Wt,e6 as $,e8 as pe,dm as Vt}from"./4813494d-di0bpg5zidu9s57f.js";import{hl as w,hm as Gt,hn as Ye,ho as Ut,hp as jt,hq as zt,hr as Bt,hs as Qt,ht as Jt,aY as ge,hu as Kt,b6 as Yt,hv as pt,hw as Xt,hx as Zt,hy as xt,aH as Mt}from"./1a7ebd5f-ihenykhpblfwilpu.js";import{C as he}from"./b9ebfa06-o5t8gt8380co00ia.js";async function es({conversation:e,requestedModelId:s,completionType:i=wt.Next,sourceEvent:u,eventSource:r,completionMetadata:n,extraStreamParams:h,parentMessageId:f,promptMessage:d,existingMessages:m,prependMessages:l,appendMessages:C,profiler:T,skipNotification:I,disablePlaceholder:S,isReasoningSkipped:y,parentMessageIdPromise:v,thinkingEffort:_,callbacks:R,firstInputTimestampMs:W}){var Ae,Ie,_e,Ee,be,Re,ke,Pe,qe,we,Fe,He,Ne,Le,Oe,$e;w.set(e,!0);const V=te(),G=(Ae=u==null?void 0:u.timeStamp)!=null?Ae:performance.now(),Xe=r!=null?r:u?Gt(u):"mouse",Ze=se(),U="request-".concat(e.id,"-").concat(Ze),t=ne(e.id),F=(Ie=t==null?void 0:t.turnTraceId)!=null?Ie:null,ye=F!=null?F:At();F||D(e.id,o=>{o.turnTraceId=ye});const{conduitToken:j=null,prepareState:xe="none",lastPrepareTimestamp:Ce=null}=t!=null?t:{},Te=_t("3360722522");(_e=n==null?void 0:n.systemHints)!=null&&_e.includes(Ue.PictureV2)&&(Te.get("use_default_model")&&(s=a(()=>Et().id)),Te.get("use_standard_thinking_effort")&&(_="standard"));const H=s!=null?s:a(()=>oe(e).id),Me=a(()=>ie()),z=b.findNode(t,o=>o.message.author.role===je.Assistant||o.message.author.role===je.Tool)==null,et=(t==null?void 0:t.continuingFromSharedConversationId)!=null,tt=(t==null?void 0:t.continuingFromSharedProjectConversationId)!=null,st=!!(t!=null&&t.continuingFromSharedPostId),nt=(t==null?void 0:t.branchingFromConversationId)!=null,B=b.getConversationLastTurn(t),ot=B==null?void 0:B.messages.some(o=>{var E;return(E=o.metadata)==null?void 0:E.n7jupd_message});let g=f?b.getNode(t,f):m!=null&&m[0]?b.getParentNode(t,m[0].id):b.getCurrentNode(t),Q=f;g.message.id.startsWith(bt)&&(g=b.getParentNode(t,g.message.id),Q=(Ee=g.message.id)!=null?Ee:g.id);let P=(be=g.message.id)!=null?be:g.id;if((Re=g.message.metadata)!=null&&Re.is_hazelnut_enable_prompt){const o=b.getParentNode(t,g.id);o&&(g=o,P=(ke=o.message.id)!=null?ke:o.id,Q=P)}Ye.getState().isTakeoverInProgress&&(Ye.setState({isTakeoverInProgress:!1}),Ut(e.id),l=[...l!=null?l:[],jt()]);const J=[...m!=null?m:[],...l!=null?l:[],...d?[d]:[],...C!=null?C:[]],K=a(()=>ae(re(e))),Y=de(e.id),A=ue({clientRequestId:U,gizmoType:K,preflightTime:G,isTemporaryChat:Me,conversationId:Y!=null?Y:void 0,turnTraceId:ye,firstInputTimestampMs:W});if(A.onUserMessages(J),K===O.PROJECT&&z){const o=n==null?void 0:n.systemHints;Rt.set(e,o)}const it=a(()=>le()),at=a(()=>kt()),rt=a(()=>ce()),dt=a(()=>me()),ut=Pt.getItem(qt.ModelSlugStatsOverride),N=new he(U,V,t,e,Q,l,d,C,i,H,Xe,it,G,K===O.PROJECT,z,et,nt,tt,A,I!=null?I:!1,at,st,y,_,ut,(Pe=t==null?void 0:t.steeringAsyncTaskId)!=null?Pe:void 0,ee({disablePlaceholder:S!=null?S:!1},R),rt,dt);Ft(e.id);const p=(qe=n==null?void 0:n.systemHints)==null?void 0:qe.includes(Ht),lt=ze("155813205"),ct=p&&!lt,X=Nt();if(X){const o=!((n==null?void 0:n.systemHints)===void 0||n.systemHints.length===0||n.systemHints.length===1&&n.systemHints.includes(Ue.Search)),E=((He=(Fe=(we=d==null?void 0:d.metadata)==null?void 0:we.attachments)==null?void 0:Fe.length)!=null?He:0)>0,k=d!=null&&d.metadata?d.metadata[Lt]:void 0,c=!!((Ne=k==null?void 0:k.sources)!=null&&Ne.length),ht=o||E||c;if(d){const De=Ot(d,{shouldGetTextFromContentReferences:!1,shouldGetVisibleText:!0});if(zt.getState().updateFromEvent(De,Bt(ht)),z)try{const Ct=$t("3205212221").get("optimistic_fetch",{}),M=We=>{const L=Ct[We];typeof L!="number"||!isFinite(L)||L<=0||Math.random()<L&&Qt(De,We)};M("images"),M("videos"),M("news")}catch(yt){}}}p&&Be.addAction("agent.conversation.start_attempted",{client_thread_id:String(e.id),model:H});const mt=ze("2036503533"),Se=((Le=t==null?void 0:t.steeringAsyncTaskId)==null?void 0:Le.startsWith("thinking"))||((Oe=t==null?void 0:t.steeringAsyncTaskId)==null?void 0:Oe.startsWith("promode"))&&mt?void 0:Jt(e.id,void 0,{clientInitiated:!0,reason:"new_completion",hasAgentSystemHint:p});if(Dt.publish({kind:"requestCompletion"}),ge(e.id,{source:fe.CLIENT,value:ct?q.REALTIME:q.STREAMING}),Kt.onCompletionRequestStarted(U),N.updateBeforeRequest(),(($e=Yt(e.id))==null?void 0:$e.value)===q.REALTIME&&!!!(ot&&y)&&Se){const o=await A.awaitWrapper(Se,"abortCompletion");o!=null&&o.last_message_id&&(P=o.last_message_id)}if(v){const o=await A.awaitWrapper(v,"parentMessageId");o&&(P=o)}const Z=pt(n),{chatReq:ve,turnstileToken:ft,proofToken:gt}=Xt(Z)?await A.awaitWrapper(Z,"completionIntegrity"):Z;if(ve.force_login)return;if(V.getQueriesData(Qe())==null&&await A.awaitWrapper(V.ensureQueryData(Qe()),"modelsQuery"),Zt()){const o=await A.awaitWrapper(xt(),"blockingPromises"),E=c=>typeof c=="object"&&c!=null&&"id"in c,k=o.flatMap(c=>c.status!=="fulfilled"||!c.value?[]:Array.isArray(c.value)?c.value.filter(E):E(c.value)?[c.value]:[]);if(k.length>0){const c=[...k].reverse();J.unshift(...c),ts({conversation:e,request:N,messages:c})}}A.onCompletionStarted(i,H),N.preflightTime=performance.now()-G;const x=Mt();if(Be.addFeatureFlagEvaluation("fast_convo",x),x&&Ce!=null){const o=performance.now()-Ce;o<=6e4&&Je.hist(Ke.DEFAULT,"fast_conversation_last_prepare_to_convo_client",[{key:"model_id",value:H},{key:"prepare_state",value:String(xe)},{key:"has_conduit_token",value:j!=null?"true":"false"}],o)}x&&X&&Je.count(Ke.DEFAULT,"client_request_conduit_token",[{key:"has_conduit_token",value:j!=null?"true":"false"}]),X&&(T==null||T.logTimingOnce("prompt_request_started")),await N.sendRequest({conduitToken:j,turnstileToken:ft,proofToken:gt,completionMetadata:n,resolvedParentMessageId:P,messages:J,extraStreamParams:h,chatReq:ve,profiler:T})}function ts({conversation:e,request:s,messages:i}){D(e.id,u=>{Wt.updateTree(u,r=>{var h,f,d,m;const n=(m=(f=(h=s.prependMessages)==null?void 0:h[0])!=null?f:s.promptMessage)!=null?m:(d=s.appendMessages)==null?void 0:d[0];if(n&&r.containsNodeOrMessageId(n.id)){for(const l of i)r.containsNodeOrMessageId(l.id)||r.prependNode(n.id,l);return}})})}async function cs({conversation:e,completionType:s,token:i,serverThreadId:u,preflightTime:r,turnTraceId:n}){const h=r!=null?r:performance.now();if(a(()=>w(e)))return;w.set(e,!0);const f=te(),d=a(()=>ae(re(e))),m=a(()=>oe(e).id),l=a(()=>ie()),C=a(()=>le()),T=a(()=>ce()),I=a(()=>me());ge(e.id,{source:fe.CLIENT,value:q.STREAMING});const S=se(),y="request-".concat(e.id,"-").concat(S),v=de(e.id);n&&D(e.id,W=>{W.turnTraceId=n});const _=ue({mode:"reload",resumeReason:"reload",clientRequestId:y,gizmoType:d,preflightTime:h,isTemporaryChat:l,conversationId:v!=null?v:u,turnTraceId:n});ne(e.id)||$.initThread({clientThreadId:e.id,conversationMode:{kind:pe.PrimaryAssistant},userId:void 0,accountId:void 0}),$.retainThread(e.id);const R=new he(y,f,void 0,e,void 0,void 0,void 0,void 0,s,m,"url",C,h,d===O.PROJECT,!1,!1,!1,!1,_,void 0,!1,void 0,void 0,void 0,void 0,void 0,{disablePlaceholder:!0},T,I);R.preflightTime=0,await R.sendResumeRequest({conversationId:u,resumeToken:i,profiler:void 0})}async function ms({conversation:e,completionType:s,serverThreadId:i,preflightTime:u,turnTraceId:r}){const n=u!=null?u:performance.now();if(a(()=>w(e)))return;w.set(e,!0);const h=te(),f=a(()=>ae(re(e))),d=a(()=>oe(e).id),m=a(()=>ie()),l=a(()=>le()),C=a(()=>ce()),T=a(()=>me());ge(e.id,{source:fe.CLIENT,value:q.STREAMING});const I=se(),S="request-".concat(e.id,"-").concat(I),y=de(e.id);r&&D(e.id,R=>{R.turnTraceId=r});const v=ue({clientRequestId:S,gizmoType:f,preflightTime:n,isTemporaryChat:m,conversationId:y!=null?y:void 0,turnTraceId:r});ne(e.id)||$.initThread({clientThreadId:e.id,conversationMode:{kind:pe.PrimaryAssistant},userId:void 0,accountId:void 0}),$.retainThread(e.id);const _=new he(S,h,void 0,e,void 0,void 0,void 0,void 0,s,d,"url",l,n,f===O.PROJECT,!1,!1,!1,!1,v,void 0,!1,void 0,void 0,void 0,void 0,void 0,{disablePlaceholder:!0},C,T);_.preflightTime=0,await _.resumeWithPolling({conversationId:i,profiler:void 0,turnTraceId:r})}function fs(e){"use forget";const s=It.c(4);let i;s[0]!==e?(i=Vt(e),s[0]=e,s[1]=i):i=s[1];const u=i;let r;return s[2]!==u?(r=n=>es(ee({conversation:u},n)),s[2]=u,s[3]=r):r=s[3],r}export{cs as a,ms as b,es as r,fs as u};
//# sourceMappingURL=b81d67c1-g85xaexv7seu9n1r.js.map
